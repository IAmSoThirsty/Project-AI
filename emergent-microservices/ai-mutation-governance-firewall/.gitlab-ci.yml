"""GitLab CI/CD Pipeline for AI Mutation Governance Firewall"""

stages:
  - build
  - test
  - security
  - package
  - deploy

variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - venv/

# Build Stage
build:
  stage: build
  image: python:${PYTHON_VERSION}
  script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  artifacts:
    paths:
      - venv/
    expire_in: 1 hour

# Test Stage
unit-tests:
  stage: test
  image: python:${PYTHON_VERSION}
  dependencies:
    - build
  script:
    - source venv/bin/activate
    - pytest tests/ --cov=app --cov-report=xml --cov-report=term
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

# Security Stage
security-scan:
  stage: security
  image: python:${PYTHON_VERSION}
  dependencies:
    - build
  script:
    - pip install bandit
    - bandit -r app/ -f json -o bandit-report.json || true
  artifacts:
    reports:
      sast: bandit-report.json
  allow_failure: true

# Package Stage  
container-build:
  stage: package
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  only:
    - main

# Deploy Stages
deploy-dev:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl set image deployment/AI Mutation Governance Firewall AI Mutation Governance Firewall=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA -n dev
    - kubectl rollout status deployment/AI Mutation Governance Firewall -n dev
  environment:
    name: dev
  only:
    - main

deploy-prod:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl set image deployment/AI Mutation Governance Firewall AI Mutation Governance Firewall=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA -n production
    - kubectl rollout status deployment/AI Mutation Governance Firewall -n production
  environment:
    name: production
  when: manual
  only:
    - main
