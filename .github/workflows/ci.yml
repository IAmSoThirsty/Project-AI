name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run linters
        run: |
          python -m pip install ruff isort black
          isort src tests --profile black
          ruff check src tests
          black --check src tests

      - name: Run tests with coverage
        run: |
          mkdir -p reports htmlcov
          env PYTHONPATH=src python -m pytest tests/ --cov=src/app/core --cov-report=term-missing --cov-report=xml:reports/coverage.xml --cov-report=html:htmlcov -q

      - name: Run Bandit security scan
        run: |
          python -m pip install bandit
          bandit -r src -x htmlcov,reports

      - name: Install npm dependencies
        run: |
          npm ci

      - name: Lint markdown docs
        run: |
          npm run lint:markdown

      - name: Upload coverage XML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: reports/coverage.xml

      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: htmlcov
