name: Update Test Documentation

on:
  # Run after other test workflows complete
  workflow_run:
    workflows:
      - "Project AI - CI/CD Pipeline"
      - "TARL CI"
      - "Node.js CI"
      - "CI Consolidated"
    types:
      - completed
    branches:
      - main
      - develop
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no commits)'
        required: false
        type: boolean
        default: false
      skip_commit:
        description: 'Skip git commit step'
        required: false
        type: boolean
        default: false
  
  # Run on schedule (daily at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-test-docs:
    name: Update Test Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"
      
      - name: Check for test artifacts
        id: check_artifacts
        run: |
          echo "Checking for test artifacts..."
          
          # Check for ci-reports
          if [ -d "ci-reports" ] && [ "$(ls -A ci-reports)" ]; then
            echo "Found ci-reports directory with files"
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
          else
            echo "No ci-reports found"
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
          fi
          
          # List found artifacts
          echo "Available artifacts:"
          find ci-reports test-artifacts test_execution_reports -type f 2>/dev/null || echo "No artifact directories found"
      
      - name: Download test artifacts from previous runs
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v3
        with:
          name: test-results
          path: ci-reports/
        continue-on-error: true
      
      - name: Run documentation maintenance system
        id: maintain_docs
        run: |
          echo "Running complete documentation maintenance system..."
          
          # Build command with options
          CMD="python scripts/run_documentation_maintenance.py"
          
          # Add dry-run flag if requested
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            CMD="$CMD --dry-run"
            echo "Running in DRY RUN mode"
          fi
          
          # Add no-commit flag if requested
          if [ "${{ github.event.inputs.skip_commit }}" = "true" ]; then
            CMD="$CMD --no-commit"
            echo "Skipping commit step"
          fi
          
          # Add verbose flag
          CMD="$CMD --verbose"
          
          # Add age checking (default: 7 days)
          CMD="$CMD --check-age --age-threshold 7"
          
          # Run the maintenance system
          $CMD
          
          # Check if files were updated
          if git diff --quiet; then
            echo "No documentation changes needed"
            echo "docs_updated=false" >> $GITHUB_OUTPUT
          else
            echo "Documentation updated"
            echo "docs_updated=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload reports
        uses: actions/upload-artifact@v3
        with:
          name: documentation-maintenance-reports
          path: |
            documentation_maintenance_report.md
            test_documentation_update_summary.md
            historical_docs_organization_report.md
            test_report_updater.log
            historical_docs_organizer.log
            documentation_maintenance.log
          retention-days: 30
      
      - name: Create Pull Request (if changes made)
        if: steps.maintain_docs.outputs.docs_updated == 'true' && github.event.inputs.dry_run != 'true' && github.event.inputs.skip_commit != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: automated documentation maintenance [CI]'
          branch: auto-update-docs-${{ github.run_number }}
          delete-branch: true
          title: 'ðŸ¤– Automated documentation maintenance'
          body: |
            ## ðŸ¤– Automated Documentation Maintenance
            
            This PR was automatically generated by the documentation maintenance system.
            
            ### Changes
            
            #### Test Documentation Updates
            - âœ… Updated test statistics and badges
            - âœ… Refreshed pass/fail counts per category
            - âœ… Surfaced any failed test examples
            - âœ… Synchronized documentation with latest CI artifacts
            
            #### Historical Documentation Organization
            - âœ… Identified and moved obsolete documents to `docs/historical/`
            - âœ… Checked files older than 7 days for usefulness
            - âœ… Updated all references to moved files
            - âœ… Created historical documentation index
            
            ### Reports Generated
            - `documentation_maintenance_report.md` - Master report
            - `test_documentation_update_summary.md` - Test update details
            - `historical_docs_organization_report.md` - Historical org details
            
            ### Review
            Please review the changes to ensure accuracy. This PR can be merged automatically if all checks pass.
            
            ---
            
            **Triggered by:** ${{ github.event_name }}
            **Workflow Run:** ${{ github.run_id }}
          labels: |
            automated
            documentation
            maintenance
          assignees: ${{ github.actor }}
      
      - name: Comment on workflow run (if triggered by workflow_run)
        if: github.event_name == 'workflow_run' && steps.maintain_docs.outputs.docs_updated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = 'Documentation maintenance completed successfully.';
            
            try {
              if (fs.existsSync('documentation_maintenance_report.md')) {
                summary = fs.readFileSync('documentation_maintenance_report.md', 'utf8');
              }
            } catch (error) {
              console.log('Could not read summary file:', error);
            }
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `## ðŸ¤– Documentation Maintenance Complete\n\n${summary}`
            });
      
      - name: Summary
        if: always()
        run: |
          echo "## Documentation Maintenance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "documentation_maintenance_report.md" ]; then
            cat documentation_maintenance_report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Master report not generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Workflow Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # Auto-merge job (optional)
  auto-merge:
    name: Auto-merge PR
    needs: update-test-docs
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Wait for checks
        uses: fountainhead/action-wait-for-check@v1.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Update Test Documentation
          ref: ${{ github.ref }}
          timeoutSeconds: 600
        continue-on-error: true
      
      - name: Enable auto-merge for PR
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
        continue-on-error: true
