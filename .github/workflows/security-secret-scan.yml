name: Security - Secret Scanning

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

permissions:
    contents: read

jobs:
    secret-scan:
        name: Scan for Exposed Secrets
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Full history for thorough scanning

            - name: Install TruffleHog
              run: |
                  curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

            - name: Scan for secrets (full repo)
              run: |
                  trufflehog filesystem . \
                    --exclude-paths=node_modules \
                    --fail \
                    --no-update \
                    --json 2>/dev/null | head -100

            - name: Scan for high-entropy strings
              run: |
                  pip install detect-secrets
                  detect-secrets scan \
                    --all-files \
                    --exclude-files '\.lock$|node_modules|\.git/' \
                    --exclude-secrets 'example|placeholder|test|dummy' \
                    > .secrets-report.json
                  python -c "
                  import json, sys
                  with open('.secrets-report.json') as f:
                      report = json.load(f)
                  results = report.get('results', {})
                  total = sum(len(v) for v in results.values())
                  if total > 0:
                      print(f'::warning::Found {total} potential secret(s) across {len(results)} file(s)')
                      for filename, secrets in results.items():
                          for secret in secrets:
                              print(f'  {filename}:{secret[\"line_number\"]} - {secret[\"type\"]}')
                  else:
                      print('No secrets detected.')
                  "

            - name: Check for .env files
              run: |
                  ENVFILES=$(find . -name '.env' -not -path '*/node_modules/*' -not -path '*/.git/*')
                  if [ -n "$ENVFILES" ]; then
                    echo "::error::Found .env file(s) that should not be committed:"
                    echo "$ENVFILES"
                    exit 1
                  fi
                  echo "No .env files found in repository."

            - name: Check for private keys
              run: |
                  KEYS=$(grep -rl 'PRIVATE KEY' --include='*.pem' --include='*.key' --include='*.p12' . 2>/dev/null || true)
                  if [ -n "$KEYS" ]; then
                    echo "::error::Found private key file(s):"
                    echo "$KEYS"
                    exit 1
                  fi
                  echo "No private key files found."
