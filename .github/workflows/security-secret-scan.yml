name: Security - Secret Scanning

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  secret-scan:
    name: Scan for Hardcoded Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for complete scanning
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit detect-secrets truffleHog3
      
      - name: Run Bandit (Python Security Linter)
        continue-on-error: true
        run: |
          echo "ðŸ” Running Bandit security linter..."
          bandit -r src/ tools/ scripts/ -f json -o bandit-report.json || true
          bandit -r src/ tools/ scripts/ -f txt || true
      
      - name: Run detect-secrets
        continue-on-error: true
        run: |
          echo "ðŸ” Running detect-secrets scanner..."
          detect-secrets scan --all-files --force-use-all-plugins \
            --exclude-files '\.lock$' \
            --exclude-files '\.pyc$' \
            --exclude-files 'node_modules/' \
            --exclude-files '\.git/' \
            > .secrets.baseline || true
          
          # Audit results
          if [ -f .secrets.baseline ]; then
            echo "ðŸ“Š Secrets baseline created"
            cat .secrets.baseline
          fi
      
      - name: Run TruffleHog (Git History Scanner)
        continue-on-error: true
        run: |
          echo "ðŸ” Running TruffleHog on git history..."
          trufflehog3 -v -r https://github.com/${{ github.repository }} \
            --branch ${{ github.ref_name }} \
            --max-depth 100 \
            || true
      
      - name: Run Enhanced Secret Scanner
        id: enhanced-scan
        continue-on-error: true
        run: |
          echo "ðŸ” Running enhanced secret scanner..."
          python tools/enhanced_secret_scan.py --report enhanced-scan-report.json
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -eq 2 ]; then
            echo "âŒ CRITICAL secrets found!"
            echo "critical_found=true" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 1 ]; then
            echo "âš ï¸  Secrets found"
            echo "secrets_found=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No secrets found"
            echo "secrets_found=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload Scan Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: secret-scan-reports
          path: |
            bandit-report.json
            .secrets.baseline
            enhanced-scan-report.json
          retention-days: 30
      
      - name: Check for Critical Findings
        if: steps.enhanced-scan.outputs.critical_found == 'true'
        run: |
          echo "::error::CRITICAL secrets detected! Immediate action required."
          echo "Review the scan reports and rotate exposed credentials immediately."
          exit 1
      
      - name: Comment on PR (if secrets found)
        if: github.event_name == 'pull_request' && steps.enhanced-scan.outputs.secrets_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## âš ï¸ Security Alert: Potential Secrets Detected\n\n';
            comment += 'The secret scanner has detected potential secrets in this PR.\n\n';
            comment += '**Action Required:**\n';
            comment += '1. Review the scan results in the workflow artifacts\n';
            comment += '2. Remove any hardcoded secrets\n';
            comment += '3. Use environment variables instead\n';
            comment += '4. See `docs/security/SECRET_MANAGEMENT.md` for guidance\n\n';
            comment += '**If these are false positives:**\n';
            comment += '- Add the file to ALLOWED_FILES in `tools/enhanced_secret_scan.py`\n';
            comment += '- Document why the finding is safe\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Security Summary
        if: always()
        run: |
          echo "## ðŸ” Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Bandit | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| detect-secrets | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| TruffleHog | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Enhanced Scanner | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed reports in workflow artifacts." >> $GITHUB_STEP_SUMMARY
