name: CI - Consolidated

on:
  push:
    branches: [main, cerberus-integration, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: read
  checks: write
  actions: read

jobs:
  # =========================================================================
  # PYTHON CI/CD PIPELINE
  # =========================================================================
  python-test:
    name: Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - name: Pre-push validation - actionlint
        run: |
          echo "üîç Running actionlint for workflow syntax validation..."
          if ! command -v actionlint &> /dev/null; then
            echo "Installing actionlint..."
            wget -q https://github.com/rhysd/actionlint/releases/download/v1.6.27/actionlint_1.6.27_linux_amd64.tar.gz
            tar -xzf actionlint_1.6.27_linux_amd64.tar.gz
            sudo mv actionlint /usr/local/bin/ 2>/dev/null || mv actionlint "$HOME/.local/bin/" || export PATH=".:$PATH"
          fi
          actionlint .github/workflows/*.yml || echo "‚ö†Ô∏è  actionlint found issues"
        continue-on-error: true

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # pinned from actions/checkout@v4
        with:
          submodules: recursive

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@0ae58b7817e9b40c6232e8bf08f42a7a6b8e60ec  # pinned from actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install project requirements
        run: |
          echo "üì¶ Installing dependencies from requirements.txt..."
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
            echo "‚úÖ Installed requirements.txt"
          else
            echo "‚ö†Ô∏è  No requirements.txt found"
          fi

      - name: Install dev requirements
        run: |
          echo "üì¶ Installing dev dependencies from requirements-dev.txt..."
          if [ -f requirements-dev.txt ]; then
            python -m pip install -r requirements-dev.txt
            echo "‚úÖ Installed requirements-dev.txt"
          else
            echo "‚ö†Ô∏è  No requirements-dev.txt found, skipping"
          fi

      - name: Install Poetry dependencies (if configured)
        run: |
          echo "üì¶ Checking for Poetry configuration..."
          if [ -f pyproject.toml ] && grep -q "\[tool.poetry\]" pyproject.toml; then
            echo "Poetry configuration found, installing Poetry and dependencies..."
            python -m pip install poetry
            poetry install
            echo "‚úÖ Installed Poetry dependencies"
          else
            echo "‚ö†Ô∏è  No Poetry configuration found, skipping"
          fi

      - name: Failsafe - Scan and install missing dependencies with pipreqs
        run: |
          echo "üîç Failsafe: Scanning codebase for any missing dependencies..."
          python -m pip install pipreqs || true
          
          # Generate requirements from actual imports
          pipreqs . --force --savepath /tmp/discovered_requirements.txt 2>/dev/null || true
          
          if [ -f /tmp/discovered_requirements.txt ]; then
            echo "üìã Discovered dependencies:"
            cat /tmp/discovered_requirements.txt
            
            echo "üì¶ Installing discovered dependencies..."
            python -m pip install -r /tmp/discovered_requirements.txt || true
            echo "‚úÖ Failsafe installation complete"
          else
            echo "‚ö†Ô∏è  No additional dependencies discovered"
          fi

      - name: Install dev tools
        run: python -m pip install ruff mypy pip-audit pre-commit black isort pytest-cov bandit

      - name: Run pre-commit hooks
        run: |
          echo "Running pre-commit hooks (black, isort, etc.)..."
          pre-commit run --all-files || true
          echo "Pre-commit check complete"
        continue-on-error: true
      
      - name: Code style - Black
        run: |
          echo "Checking code formatting with Black..."
          black --check src/ tests/ || {
            echo "‚ùå Black formatting check failed"
            echo "Run 'black src/ tests/' to fix formatting"
            exit 1
          }
          echo "‚úÖ Black formatting check passed"
        continue-on-error: false

      - name: Lint (ruff)
        run: |
          echo "Running ruff linter..."
          ruff check . --output-format=github
          if [ $? -ne 0 ]; then
            echo "‚ùå Ruff linting failed. Please fix the issues above."
            exit 1
          fi
          echo "‚úÖ Ruff linting passed"

      - name: Security scan (bandit)
        run: |
          echo "üîí Running Bandit security scanner..."
          bandit -r src/ -f screen || echo "‚ö†Ô∏è  Bandit found security issues"
        continue-on-error: true

      - name: Type check (mypy)
        run: mypy src
        continue-on-error: true

      - name: Check required secrets (non-fatal)
        run: |
          echo "Checking required secrets..."
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then echo "OPENAI_API_KEY not set; some tests requiring OpenAI will be skipped"; fi
          if [ -z "${{ secrets.HUGGINGFACE_API_KEY }}" ]; then echo "HUGGINGFACE_API_KEY not set; image generation tests will be skipped"; fi
          echo "Secrets check complete"

      - name: Security audit (pip-audit)
        run: pip-audit --format json -o pip_audit_report.json
        continue-on-error: true

      - name: Upload pip-audit report
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # pinned from actions/upload-artifact@v4
        with:
          name: pip-audit-report-${{ matrix.python-version }}
          path: pip_audit_report.json

      - name: Run tests with coverage
        run: pytest --cov=src --cov-report=xml:reports/coverage.xml --cov-report=term-missing -q

      - name: Check coverage threshold
        run: |
          echo "Checking coverage threshold (minimum 80%)..."
          COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('reports/coverage.xml'); root = tree.getroot(); print(root.attrib.get('line-rate', '0'))")
          COVERAGE_PERCENT=$(python -c "print(float('$COVERAGE') * 100)")
          echo "Current coverage: ${COVERAGE_PERCENT}%"
          
          if (( $(echo "$COVERAGE_PERCENT < 80" | bc -l) )); then
            echo "‚ùå FAILED: Coverage ${COVERAGE_PERCENT}% is below minimum threshold of 80%"
            echo "Please add tests to increase coverage."
            exit 1
          fi
          
          echo "‚úÖ Coverage threshold met: ${COVERAGE_PERCENT}%"
        continue-on-error: false

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # pinned from actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: reports/coverage.xml

      - name: Run tests (Cerberus submodule)
        working-directory: external/Cerberus
        run: pytest -q
        continue-on-error: true

  # =========================================================================
  # CLI TESTS
  # =========================================================================
  cli-tests:
    name: CLI Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # pinned from actions/checkout@v4

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Set up Python
        uses: actions/setup-python@0ae58b7817e9b40c6232e8bf08f42a7a6b8e60ec  # pinned from actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          echo "üì¶ Installing all project dependencies..."
          python -m pip install --upgrade pip
          
          # Install main requirements
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
            echo "‚úÖ Installed requirements.txt"
          fi
          
          # Install dev requirements
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
            echo "‚úÖ Installed requirements-dev.txt"
          fi
          
          # Check for Poetry configuration
          if [ -f pyproject.toml ] && grep -q "\[tool.poetry\]" pyproject.toml; then
            python -m pip install poetry
            poetry install
            echo "‚úÖ Installed Poetry dependencies"
          fi
          
          # Failsafe with pipreqs
          pip install pipreqs || true
          pipreqs . --force --savepath /tmp/discovered_requirements.txt 2>/dev/null || true
          if [ -f /tmp/discovered_requirements.txt ]; then
            pip install -r /tmp/discovered_requirements.txt || true
            echo "‚úÖ Installed discovered dependencies"
          fi
          
          # Install test tools
          pip install pytest pytest-cov ruff mypy

      - name: Lint CLI code
        run: |
          ruff check src/app/cli.py src/app/core/config.py
          echo "‚úì CLI linting passed"

      - name: Type check CLI
        run: |
          mypy src/app/cli.py src/app/core/config.py --ignore-missing-imports
          echo "‚úì CLI type checking passed"
        continue-on-error: true

      - name: Run CLI tests
        run: |
          pytest tests/test_cli.py -v --cov=src/app/cli --cov=src/app/core/config --cov-report=xml
          echo "‚úì CLI tests passed"

      - name: CLI smoke tests
        run: |
          python -m app.cli --help
          python -m app.cli --version
          python -m app.cli user --help
          python -m app.cli memory --help
          python -m app.cli learning --help
          python -m app.cli plugin --help
          python -m app.cli system --help
          python -m app.cli ai --help
          echo "‚úì All CLI smoke tests passed"

      - name: Generate CLI documentation
        run: |
          python scripts/generate_cli_docs.py
          echo "‚úì CLI documentation generated"
        continue-on-error: true

      - name: Upload CLI coverage
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # pinned from actions/upload-artifact@v4
        with:
          name: cli-coverage-report
          path: coverage.xml

  # =========================================================================
  # NODE.JS CI
  # =========================================================================
  node-tests:
    name: Node.js Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['18.x']
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # pinned from actions/checkout@v4

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b  # pinned from actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type checking
        run: npm run typecheck || echo "No typecheck script defined ‚Äî skipping"

      - name: Run tests
        run: npm test || echo "No test script defined ‚Äî skipping"

      - name: Run tests with coverage
        run: npm run test:coverage || echo "No test:coverage script defined ‚Äî skipping"

      - name: Build
        run: npm run build || echo "No build script defined ‚Äî skipping"

      - name: npm audit (security scan)
        run: npm audit --audit-level=moderate || true

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # pinned from actions/upload-artifact@v4
        with:
          name: node-coverage-${{ matrix.node-version }}
          path: |
            coverage/**
            coverage.*

  # =========================================================================
  # PYTHON-IN-NODE (for web backend)
  # =========================================================================
  python-in-node:
    name: Python CI (from Node workflow)
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: src
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # pinned from actions/checkout@v4

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Detect Python files
        id: detect_py
        run: |
          count=$(git ls-files "**/*.py" | wc -l || true)
          echo "found=$count" >> $GITHUB_OUTPUT

      - name: Setup Python
        if: steps.detect_py.outputs.found != '0'
        uses: actions/setup-python@0ae58b7817e9b40c6232e8bf08f42a7a6b8e60ec  # pinned from actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python test deps
        if: steps.detect_py.outputs.found != '0'
        run: |
          echo "üì¶ Installing all project dependencies..."
          python -m pip install --upgrade pip
          
          # Install main requirements
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
            echo "‚úÖ Installed requirements.txt"
          fi
          
          # Install dev requirements
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
            echo "‚úÖ Installed requirements-dev.txt"
          fi
          
          # Check for Poetry configuration
          if [ -f pyproject.toml ] && grep -q "\[tool.poetry\]" pyproject.toml; then
            python -m pip install poetry
            poetry install
            echo "‚úÖ Installed Poetry dependencies"
          fi
          
          # Failsafe with pipreqs
          pip install pipreqs || true
          pipreqs . --force --savepath /tmp/discovered_requirements.txt 2>/dev/null || true
          if [ -f /tmp/discovered_requirements.txt ]; then
            pip install -r /tmp/discovered_requirements.txt || true
            echo "‚úÖ Installed discovered dependencies"
          fi
          
          # Install test tools
          pip install pytest flake8 pytest-cov

      - name: Run flake8
        if: steps.detect_py.outputs.found != '0'
        run: flake8 . || true

      - name: Run pytest
        if: steps.detect_py.outputs.found != '0'
        run: pytest --junitxml=reports/junit.xml --cov=src --cov-report=xml:reports/coverage.xml -q

      - name: Upload JUnit report
        if: always() && (steps.detect_py.outputs.found != '0')
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # pinned from actions/upload-artifact@v4
        with:
          name: junit-report
          path: reports/junit.xml

      - name: Upload pytest coverage
        if: always() && (steps.detect_py.outputs.found != '0')
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # pinned from actions/upload-artifact@v4
        with:
          name: pytest-coverage-report
          path: reports/coverage.xml

      - name: Annotate JUnit failures
        if: always() && (steps.detect_py.outputs.found != '0')
        run: |
          python .github/scripts/annotate_junit.py reports/junit.xml || true

  # =========================================================================
  # DOCKER BUILD & SMOKE TEST
  # =========================================================================
  docker-build:
    name: Docker Build & Smoke Test
    runs-on: ubuntu-latest
    needs: [python-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # pinned from actions/checkout@v4

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf  # pinned from docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@988b5a0280414f521da01fcc63a27aeeb4b104db  # pinned from docker/setup-buildx-action@v2

      - name: Build Docker image
        uses: docker/build-push-action@48aba3b46d1b1fec4febb7c5d0c644b249a11355  # pinned from docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: project-ai:ci

      - name: Smoke test image
        run: |
          docker run --rm project-ai:ci python -c "print('smoke')"

  # =========================================================================
  # CODACY ANALYSIS
  # =========================================================================
  codacy:
    name: Codacy Analysis
    runs-on: ubuntu-latest
    needs: [python-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # pinned from actions/checkout@v4

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Set up Python
        uses: actions/setup-python@0ae58b7817e9b40c6232e8bf08f42a7a6b8e60ec  # pinned from actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install codacy CLI
        run: pip install codacy-cli

      - name: Run Codacy analysis
        env:
          CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
        run: |
          if [ -z "${CODACY_PROJECT_TOKEN}" ]; then 
            echo "CODACY_PROJECT_TOKEN not set, skipping"
            exit 0
          fi
          codacy analyze --directory .
