name: CI - Consolidated

on:
  push:
    branches: [main, cerberus-integration, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: read
  checks: write
  actions: read

jobs:
  # =========================================================================
  # PYTHON CI/CD PIPELINE
  # =========================================================================
  python-test:
    name: Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install project requirements
        run: python -m pip install -r requirements.txt

      - name: Install dev tools
        run: python -m pip install ruff mypy pip-audit pre-commit black isort pytest-cov

      - name: Run pre-commit hooks
        run: pre-commit run --all-files
        continue-on-error: true

      - name: Lint (ruff)
        run: ruff check .

      - name: Type check (mypy)
        run: mypy src
        continue-on-error: true

      - name: Check required secrets (non-fatal)
        run: |
          echo "Checking required secrets..."
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then echo "OPENAI_API_KEY not set; some tests requiring OpenAI will be skipped"; fi
          if [ -z "${{ secrets.HUGGINGFACE_API_KEY }}" ]; then echo "HUGGINGFACE_API_KEY not set; image generation tests will be skipped"; fi
          echo "Secrets check complete"

      - name: Security audit (pip-audit)
        run: pip-audit --format json -o pip_audit_report.json
        continue-on-error: true

      - name: Upload pip-audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report-${{ matrix.python-version }}
          path: pip_audit_report.json

      - name: Run tests with coverage
        run: pytest --cov=src --cov-report=xml:reports/coverage.xml -q

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: reports/coverage.xml

      - name: Run tests (Cerberus submodule)
        working-directory: external/Cerberus
        run: pytest -q
        continue-on-error: true

  # =========================================================================
  # CLI TESTS
  # =========================================================================
  cli-tests:
    name: CLI Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov ruff mypy

      - name: Lint CLI code
        run: |
          ruff check src/app/cli.py src/app/core/config.py
          echo "✓ CLI linting passed"

      - name: Type check CLI
        run: |
          mypy src/app/cli.py src/app/core/config.py --ignore-missing-imports
          echo "✓ CLI type checking passed"
        continue-on-error: true

      - name: Run CLI tests
        run: |
          pytest tests/test_cli.py -v --cov=src/app/cli --cov=src/app/core/config --cov-report=xml
          echo "✓ CLI tests passed"

      - name: CLI smoke tests
        run: |
          python -m app.cli --help
          python -m app.cli --version
          python -m app.cli user --help
          python -m app.cli memory --help
          python -m app.cli learning --help
          python -m app.cli plugin --help
          python -m app.cli system --help
          python -m app.cli ai --help
          echo "✓ All CLI smoke tests passed"

      - name: Generate CLI documentation
        run: |
          python scripts/generate_cli_docs.py
          echo "✓ CLI documentation generated"
        continue-on-error: true

      - name: Upload CLI coverage
        uses: actions/upload-artifact@v4
        with:
          name: cli-coverage-report
          path: coverage.xml

  # =========================================================================
  # NODE.JS CI
  # =========================================================================
  node-tests:
    name: Node.js Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['18.x']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type checking
        run: npm run typecheck || echo "No typecheck script defined — skipping"

      - name: Run tests
        run: npm test || echo "No test script defined — skipping"

      - name: Run tests with coverage
        run: npm run test:coverage || echo "No test:coverage script defined — skipping"

      - name: Build
        run: npm run build || echo "No build script defined — skipping"

      - name: npm audit (security scan)
        run: npm audit --audit-level=moderate || true

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: node-coverage-${{ matrix.node-version }}
          path: |
            coverage/**
            coverage.*

  # =========================================================================
  # PYTHON-IN-NODE (for web backend)
  # =========================================================================
  python-in-node:
    name: Python CI (from Node workflow)
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: src
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Detect Python files
        id: detect_py
        run: |
          count=$(git ls-files "**/*.py" | wc -l || true)
          echo "found=$count" >> $GITHUB_OUTPUT

      - name: Setup Python
        if: steps.detect_py.outputs.found != '0'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python test deps
        if: steps.detect_py.outputs.found != '0'
        run: |
          python -m pip install --upgrade pip
          pip install pytest flake8 pytest-cov

      - name: Run flake8
        if: steps.detect_py.outputs.found != '0'
        run: flake8 . || true

      - name: Run pytest
        if: steps.detect_py.outputs.found != '0'
        run: pytest --junitxml=reports/junit.xml --cov=src --cov-report=xml:reports/coverage.xml -q

      - name: Upload JUnit report
        if: always() && (steps.detect_py.outputs.found != '0')
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: reports/junit.xml

      - name: Upload pytest coverage
        if: always() && (steps.detect_py.outputs.found != '0')
        uses: actions/upload-artifact@v4
        with:
          name: pytest-coverage-report
          path: reports/coverage.xml

      - name: Annotate JUnit failures
        if: always() && (steps.detect_py.outputs.found != '0')
        run: |
          python .github/scripts/annotate_junit.py reports/junit.xml || true

  # =========================================================================
  # DOCKER BUILD & SMOKE TEST
  # =========================================================================
  docker-build:
    name: Docker Build & Smoke Test
    runs-on: ubuntu-latest
    needs: [python-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: project-ai:ci

      - name: Smoke test image
        run: |
          docker run --rm project-ai:ci python -c "print('smoke')"

  # =========================================================================
  # CODACY ANALYSIS
  # =========================================================================
  codacy:
    name: Codacy Analysis
    runs-on: ubuntu-latest
    needs: [python-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install codacy CLI
        run: pip install codacy-cli

      - name: Run Codacy analysis
        env:
          CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
        run: |
          if [ -z "${CODACY_PROJECT_TOKEN}" ]; then 
            echo "CODACY_PROJECT_TOKEN not set, skipping"
            exit 0
          fi
          codacy analyze --directory .
