name: Post-Merge Validation

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  validate-main:
    name: Validate Main Branch Health
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for conflict detection

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff mypy pytest pytest-cov

      - name: Check for conflicts
        id: conflict-check
        run: |
          echo "Checking for merge conflicts..."
          
          # Check for conflict markers
          if git grep -n "<<<<<<< HEAD" || git grep -n "=======" || git grep -n ">>>>>>>"; then
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            echo "âŒ Conflict markers found in repository!"
          else
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            echo "âœ… No conflicts detected"
          fi

      - name: Run full linting
        id: lint
        run: |
          echo "Running linting checks..."
          set +e
          ruff check . --output-format=github > lint_output.txt 2>&1
          LINT_EXIT=$?
          set -e
          
          if [ $LINT_EXIT -eq 0 ]; then
            echo "lint_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Linting passed"
          else
            echo "lint_passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Linting failed"
            cat lint_output.txt
          fi

      - name: Run full test suite
        id: tests
        run: |
          echo "Running complete test suite..."
          set +e
          pytest -v --tb=short --maxfail=0 > test_output.txt 2>&1
          TEST_EXIT=$?
          set -e
          
          if [ $TEST_EXIT -eq 0 ]; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
            PASSED=$(grep -c "PASSED" test_output.txt || echo "0")
            echo "test_count=$PASSED" >> $GITHUB_OUTPUT
            echo "âœ… All tests passed ($PASSED tests)"
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
            FAILED=$(grep -c "FAILED" test_output.txt || echo "0")
            echo "failed_count=$FAILED" >> $GITHUB_OUTPUT
            echo "âŒ Tests failed ($FAILED failures)"
            cat test_output.txt
          fi

      - name: Generate health report
        id: report
        run: |
          REPORT_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          cat > main_health_report.md << EOF
          # Main Branch Health Report
          
          **Generated:** ${REPORT_DATE}
          **Commit:** ${{ github.sha }}
          **Triggered by:** ${{ github.event.head_commit.message }}
          
          ## Status Summary
          
          | Check | Status |
          |-------|--------|
          | Conflicts | ${{ steps.conflict-check.outputs.has_conflicts == 'false' && 'âœ… None' || 'âŒ Detected' }} |
          | Linting | ${{ steps.lint.outputs.lint_passed == 'true' && 'âœ… Passed' || 'âŒ Failed' }} |
          | Tests | ${{ steps.tests.outputs.tests_passed == 'true' && 'âœ… All Passed' || 'âŒ Failed' }} |
          
          ## Details
          
          ### Merge Conflicts
          ${{ steps.conflict-check.outputs.has_conflicts == 'false' && 'âœ… No merge conflicts detected in the main branch.' || 'âŒ CRITICAL: Merge conflict markers found! Immediate resolution required.' }}
          
          ### Linting
          ${{ steps.lint.outputs.lint_passed == 'true' && 'âœ… All code follows style guidelines.' || 'âŒ Linting errors detected. Auto-fix workflow should resolve these.' }}
          
          ### Tests
          ${{ steps.tests.outputs.tests_passed == 'true' && format('âœ… Test suite: {0}/{0} tests passing', steps.tests.outputs.test_count) || format('âŒ Test failures: {0} tests failed', steps.tests.outputs.failed_count) }}
          
          ---
          
          ## Overall Health: ${{ steps.conflict-check.outputs.has_conflicts == 'false' && steps.lint.outputs.lint_passed == 'true' && steps.tests.outputs.tests_passed == 'true' && 'âœ… HEALTHY' || 'âš ï¸ REQUIRES ATTENTION' }}
          EOF
          
          cat main_health_report.md

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: main-health-report
          path: main_health_report.md

      - name: Create issue if main is unhealthy
        if: steps.conflict-check.outputs.has_conflicts == 'true' || steps.lint.outputs.lint_passed == 'false' || steps.tests.outputs.tests_passed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const hasConflicts = '${{ steps.conflict-check.outputs.has_conflicts }}' === 'true';
            const lintFailed = '${{ steps.lint.outputs.lint_passed }}' === 'false';
            const testsFailed = '${{ steps.tests.outputs.tests_passed }}' === 'false';
            
            let issueBody = '# ðŸš¨ Main Branch Health Issue Detected\n\n';
            issueBody += '**Commit:** ${{ github.sha }}\n';
            issueBody += '**Triggered by:** ${{ github.event.head_commit.message }}\n\n';
            issueBody += '## Issues Detected\n\n';
            
            if (hasConflicts) {
              issueBody += '- âŒ **Merge conflicts** detected in main branch\n';
            }
            if (lintFailed) {
              issueBody += '- âŒ **Linting failures** detected\n';
            }
            if (testsFailed) {
              issueBody += '- âŒ **Test failures** detected (${{ steps.tests.outputs.failed_count }} tests)\n';
            }
            
            issueBody += '\n## Required Actions\n\n';
            issueBody += '1. Review the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n';
            issueBody += '2. Address failing checks immediately\n';
            issueBody += '3. The auto-fix workflow will attempt to resolve automatically\n';
            issueBody += '\n**Priority:** ðŸ”´ HIGH - Main branch stability is critical\n';
            
            // Check if similar issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'main-health-issue'
            });
            
            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Main Branch Health Issue Detected',
                body: issueBody,
                labels: ['main-health-issue', 'urgent', 'automated']
              });
            }

      - name: Comment success on recent PR if healthy
        if: steps.conflict-check.outputs.has_conflicts == 'false' && steps.lint.outputs.lint_passed == 'true' && steps.tests.outputs.tests_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Find the most recent merged PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 1
            });
            
            if (prs.length > 0 && prs[0].merged_at) {
              const pr = prs[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: 'âœ… **Post-Merge Validation Complete**\n\n' +
                      '- âœ… Zero conflicts\n' +
                      '- âœ… Zero linting errors\n' +
                      '- âœ… Zero test failures (${{ steps.tests.outputs.test_count }} tests passing)\n\n' +
                      'Main branch is healthy after this merge. ðŸŽ‰'
              });
            }
