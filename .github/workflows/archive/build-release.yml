name: Build Release Package

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
        type: string

permissions:
  contents: write
  id-token: write
  packages: read

jobs:
  build-release:
    name: Build Full Distribution Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4
        with:
          fetch-depth: 0

      - name: Set version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Extract version from tag (remove 'v' prefix)
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building version: $VERSION"

      - name: Set up Python
        uses: actions/setup-python@0ae58b7817e9b40c6232e8bf08f42a7a6b8e60ec  # v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af  # v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Set up Java (for Android build)
        uses: actions/setup-java@7a6d8a8234af8eb26422e24e3006232cccaa061b  # v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install system dependencies
        run: |
          echo "ðŸ“¦ Installing system dependencies..."
          sudo apt-get update
          sudo apt-get install -y zip tar

      - name: Install Python dependencies
        run: |
          echo "ðŸ“¦ Installing Python dependencies..."
          python -m pip install --upgrade pip setuptools wheel build
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          fi

      - name: Install Node.js dependencies (if needed)
        run: |
          if [ -d "desktop" ] && [ -f "desktop/package.json" ]; then
            echo "ðŸ“¦ Installing Node.js dependencies for desktop..."
            cd desktop
            npm ci
            cd ..
          fi

      - name: Update version in scripts
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "Updating version to $VERSION in build scripts..."
          sed -i "s/VERSION=\"1.0.0\"/VERSION=\"$VERSION\"/" scripts/build_release.sh
          sed -i "s/set VERSION=1.0.0/set VERSION=$VERSION/" scripts/build_release.bat

      - name: Build Android APK (if Android directory exists)
        run: |
          if [ -d "android" ] && [ -f "gradlew" ]; then
            echo "ðŸ“¦ Building Android APK..."
            chmod +x gradlew
            ./gradlew assembleDebug || echo "Android build failed (non-blocking)"
          else
            echo "âš ï¸  Android directory not found, skipping Android build"
          fi

      - name: Build Desktop Apps (if desktop directory exists)
        run: |
          if [ -d "desktop" ] && [ -f "desktop/package.json" ]; then
            echo "ðŸ“¦ Building Desktop apps..."
            cd desktop
            npm run build || echo "Desktop build failed (non-blocking)"
            cd ..
          else
            echo "âš ï¸  Desktop directory not found, skipping Desktop build"
          fi

      - name: Run release build script
        run: |
          echo "ðŸš€ Running release build script..."
          chmod +x scripts/build_release.sh
          chmod +x scripts/validate_release.py
          bash scripts/build_release.sh

      - name: Check build artifacts
        run: |
          echo "ðŸ“¦ Checking build artifacts..."
          ls -lh releases/
          if [ -f "releases/release-summary-v${{ steps.version.outputs.VERSION }}.json" ]; then
            echo "âœ“ Release summary found"
            cat "releases/release-summary-v${{ steps.version.outputs.VERSION }}.json"
          fi
          if [ -f "releases/validation-report-v${{ steps.version.outputs.VERSION }}.json" ]; then
            echo "âœ“ Validation report found"
            cat "releases/validation-report-v${{ steps.version.outputs.VERSION }}.json"
          fi

      - name: Generate checksums
        run: |
          cd releases
          sha256sum project-ai-v${{ steps.version.outputs.VERSION }}.tar.gz > SHA256SUMS
          sha256sum project-ai-v${{ steps.version.outputs.VERSION }}.zip >> SHA256SUMS
          sha512sum project-ai-v${{ steps.version.outputs.VERSION }}.tar.gz > SHA512SUMS
          sha512sum project-ai-v${{ steps.version.outputs.VERSION }}.zip >> SHA512SUMS
          cat SHA256SUMS
          cd ..

      - name: Upload release artifacts
        uses: actions/upload-artifact@ea3d6fb60d47c0a8aab02e95a1c69d16b0f24c1e  # v4
        with:
          name: release-package-v${{ steps.version.outputs.VERSION }}
          path: |
            releases/project-ai-v${{ steps.version.outputs.VERSION }}.tar.gz
            releases/project-ai-v${{ steps.version.outputs.VERSION }}.zip
            releases/release-summary-v${{ steps.version.outputs.VERSION }}.json
            releases/validation-report-v${{ steps.version.outputs.VERSION }}.json
            releases/SHA256SUMS
            releases/SHA512SUMS
          retention-days: 90

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@e7a8f85e1c67a31e6ed99a94b41bd0b71bbee6b8  # v2.2.0
        with:
          files: |
            releases/project-ai-v${{ steps.version.outputs.VERSION }}.tar.gz
            releases/project-ai-v${{ steps.version.outputs.VERSION }}.zip
            releases/release-summary-v${{ steps.version.outputs.VERSION }}.json
            releases/validation-report-v${{ steps.version.outputs.VERSION }}.json
            releases/SHA256SUMS
            releases/SHA512SUMS
          body: |
            # Project-AI v${{ steps.version.outputs.VERSION }}

            ## ðŸ“¦ Distribution Package

            This release includes the complete Project-AI distribution package with:

            - **Backend API** - FastAPI governance server with TARL framework
            - **Web Frontend** - Browser-based interface
            - **Android App** - APK for Android 7.0+ devices
            - **Desktop Apps** - Electron apps for Windows, macOS, and Linux
            - **Monitoring Agents** - Prometheus, Grafana, AlertManager
            - **Complete Documentation** - All guides and specifications

            ## ðŸ“Š Build Information

            - **Build Date**: ${{ github.event.head_commit.timestamp }}
            - **Commit**: ${{ github.sha }}
            - **Build Workflow**: [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ## âœ… Validation

            This release has been validated against the distribution manifest and passed all checks.
            See `validation-report-v${{ steps.version.outputs.VERSION }}.json` for details.

            ## ðŸ” Verification

            Verify checksums:
            ```bash
            sha256sum -c SHA256SUMS
            sha512sum -c SHA512SUMS
            ```

            ## ðŸš€ Quick Start

            ```bash
            # Extract the package
            tar -xzf project-ai-v${{ steps.version.outputs.VERSION }}.tar.gz
            cd project-ai-v${{ steps.version.outputs.VERSION }}

            # Start backend
            cd backend
            ./start.sh
            ```

            See README.md in the package for complete instructions.

            ## ðŸ“„ Signing

            Release artifacts will be signed with Sigstore Cosign in a separate workflow.
          fail_on_unmatched_files: false
          draft: false
          prerelease: false

      - name: Trigger artifact signing
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sign-release-artifacts.yml',
              ref: context.ref,
              inputs: {
                tag: '${{ steps.version.outputs.VERSION }}'
              }
            })

      - name: Post build summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "releases/release-summary-v${{ steps.version.outputs.VERSION }}.json" ]; then
            echo "### Release Summary" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat "releases/release-summary-v${{ steps.version.outputs.VERSION }}.json" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "releases/validation-report-v${{ steps.version.outputs.VERSION }}.json" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Validation Report" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat "releases/validation-report-v${{ steps.version.outputs.VERSION }}.json" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
