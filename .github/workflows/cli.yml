name: CLI Tests and Validation

on:
  push:
    branches: [main, cerberus-integration]
    paths:
      - 'src/app/cli.py'
      - 'src/app/core/config.py'
      - 'tests/test_cli.py'
      - 'scripts/generate_cli_docs.py'
      - '.github/workflows/cli.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/app/cli.py'
      - 'src/app/core/config.py'
      - 'tests/test_cli.py'
      - 'scripts/generate_cli_docs.py'
      - '.github/workflows/cli.yml'
  workflow_dispatch:

jobs:
  cli-lint:
    name: CLI Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Lint CLI code (ruff)
        run: |
          ruff check src/app/cli.py src/app/core/config.py
          echo "✓ CLI linting passed"

      - name: Type check CLI (mypy)
        run: |
          mypy src/app/cli.py src/app/core/config.py --ignore-missing-imports
          echo "✓ CLI type checking passed"

  cli-tests:
    name: CLI Tests
    runs-on: ubuntu-latest
    needs: cli-lint
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run CLI tests
        run: |
          pytest tests/test_cli.py -v --cov=src/app/cli --cov=src/app/core/config --cov-report=xml
          echo "✓ CLI tests passed"

      - name: Upload coverage report
        if: matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: cli-coverage-report
          path: coverage.xml

  cli-smoke-tests:
    name: CLI Smoke Tests
    runs-on: ubuntu-latest
    needs: cli-tests
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test CLI entry point
        run: |
          python -m app.cli --help
          echo "✓ CLI entry point works"

      - name: Test CLI version
        run: |
          python -m app.cli --version
          echo "✓ CLI version flag works"

      - name: Test all command groups help
        run: |
          python -m app.cli user --help
          python -m app.cli memory --help
          python -m app.cli learning --help
          python -m app.cli plugin --help
          python -m app.cli system --help
          python -m app.cli ai --help
          echo "✓ All command group helps work"

      - name: Test sample commands
        run: |
          python -m app.cli user example "TestUser"
          python -m app.cli memory example "test-memory"
          python -m app.cli learning example "test-topic"
          python -m app.cli plugin example "test-plugin"
          python -m app.cli system example "test-param"
          python -m app.cli ai example "test-model"
          echo "✓ Sample commands execute successfully"

  cli-docs:
    name: CLI Documentation
    runs-on: ubuntu-latest
    needs: cli-smoke-tests
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate CLI documentation
        run: |
          python scripts/generate_cli_docs.py
          echo "✓ CLI documentation generated"

      - name: Check if documentation is up to date
        run: |
          if git diff --exit-code docs/cli/commands.md; then
            echo "✓ CLI documentation is up to date"
          else
            echo "✗ CLI documentation is out of date"
            echo "Please run: python scripts/generate_cli_docs.py"
            git diff docs/cli/commands.md
            exit 1
          fi

      - name: Upload generated docs
        uses: actions/upload-artifact@v4
        with:
          name: cli-documentation
          path: docs/cli/

  cli-config-tests:
    name: CLI Configuration Tests
    runs-on: ubuntu-latest
    needs: cli-lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test config file loading
        run: |
          # Create test config
          cat > test_config.toml << EOF
          [general]
          log_level = "DEBUG"
          verbose = true
          
          [ai]
          model = "test-model"
          temperature = 0.9
          EOF
          
          # Test config loading (will be validated by config.py)
          python -c "from app.core.config import Config; from pathlib import Path; c = Config(Path('test_config.toml')); print('✓ Config loaded:', c.get('general', 'log_level'))"

      - name: Test environment variable overrides
        run: |
          export PROJECTAI_GENERAL_LOG_LEVEL=ERROR
          export PROJECTAI_AI_TEMPERATURE=0.5
          python -c "from app.core.config import Config; c = Config(); assert c.get('general', 'log_level') == 'ERROR'; print('✓ Environment overrides work')"

  summary:
    name: CLI Test Summary
    runs-on: ubuntu-latest
    needs: [cli-lint, cli-tests, cli-smoke-tests, cli-docs, cli-config-tests]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.cli-lint.result }}" == "success" ] && \
             [ "${{ needs.cli-tests.result }}" == "success" ] && \
             [ "${{ needs.cli-smoke-tests.result }}" == "success" ] && \
             [ "${{ needs.cli-docs.result }}" == "success" ] && \
             [ "${{ needs.cli-config-tests.result }}" == "success" ]; then
            echo "✅ All CLI checks passed!"
            exit 0
          else
            echo "❌ Some CLI checks failed"
            echo "Lint: ${{ needs.cli-lint.result }}"
            echo "Tests: ${{ needs.cli-tests.result }}"
            echo "Smoke: ${{ needs.cli-smoke-tests.result }}"
            echo "Docs: ${{ needs.cli-docs.result }}"
            echo "Config: ${{ needs.cli-config-tests.result }}"
            exit 1
          fi
