name: T.A.R.L. CI

on:
  push:
    paths:
      - 'tarl/**'
      - '.github/workflows/tarl-ci.yml'
  pull_request:
    paths:
      - 'tarl/**'
      - '.github/workflows/tarl-ci.yml'

jobs:
  tarl-lint:
    name: T.A.R.L. Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      
      - name: Run ruff linting
        run: |
          ruff check tarl/ --output-format=github
      
      - name: Run ruff formatting check
        run: |
          ruff format tarl/ --check

  tarl-test:
    name: T.A.R.L. Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
      
      - name: Run T.A.R.L. integration tests
        run: |
          pytest tarl/tests/test_tarl_integration.py -v --cov=tarl --cov-report=xml --cov-report=term
      
      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: coverage.xml

  tarl-security:
    name: T.A.R.L. Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety
      
      - name: Run Bandit security scan
        run: |
          bandit -r tarl/ -f json -o bandit-report.json || true
          bandit -r tarl/ -f screen
      
      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

  tarl-docs:
    name: T.A.R.L. Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check documentation exists
        run: |
          test -f tarl/README.md
          test -f tarl/docs/ARCHITECTURE.md
          test -f tarl/compiler/README.md
          test -f tarl/runtime/README.md
      
      - name: Check documentation quality
        run: |
          # Check README has key sections
          grep -q "## Overview" tarl/README.md
          grep -q "## Quick Start" tarl/README.md
          grep -q "## Architecture" tarl/README.md
          grep -q "## API Reference" tarl/README.md
          
          # Check architecture doc
          grep -q "## System Architecture" tarl/docs/ARCHITECTURE.md
          grep -q "## Subsystems" tarl/docs/ARCHITECTURE.md

  tarl-integration:
    name: T.A.R.L. Full Integration
    runs-on: ubuntu-latest
    needs: [tarl-lint, tarl-test, tarl-security]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install T.A.R.L.
        run: |
          python -m pip install --upgrade pip
          pip install pytest
      
      - name: Test T.A.R.L. system initialization
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from tarl import TARLSystem
          system = TARLSystem()
          system.initialize()
          status = system.get_status()
          assert status['initialized'] == True
          assert len(status['subsystems']) == 8
          print('✅ T.A.R.L. system initialized successfully')
          system.shutdown()
          print('✅ T.A.R.L. system shutdown successfully')
          "
      
      - name: Test T.A.R.L. execution
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from tarl import TARLSystem
          system = TARLSystem()
          system.initialize()
          result = system.execute_source(\"pour 'Hello, T.A.R.L.!'\")
          print('✅ T.A.R.L. executed source code successfully')
          system.shutdown()
          "
