name: Node CI and Security

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: read

jobs:
  node-checks:
    name: Node.js checks (install, typecheck, test, coverage, build, audit)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ ! -f package-lock.json ]; then
            echo "Error: package-lock.json not found. Failing CI to avoid non-deterministic npm installs."
            exit 1
          fi
          npm ci

      - name: Detect JS test files
        id: detect_js_tests
        run: |
          if [ -d "src" ]; then
            count=$(find src -type f -name '*.test.js' 2>/dev/null | wc -l)
          else
            count=0
          fi
          echo "found=$count" >> $GITHUB_OUTPUT
          echo "Found $count JS test file(s)"

      - name: Run type checking (if available)
        run: |
          if npm run -s typecheck >/dev/null 2>&1; then
            npm run typecheck;
          else
            echo "No typecheck script defined — skipping";
          fi

      - name: Run tests (if available)
        if: steps.detect_js_tests.outputs.found != '0'
        run: npm test

      - name: No JS tests found
        if: steps.detect_js_tests.outputs.found == '0'
        run: echo "No JS test files found — skipping JS tests."

      - name: Run tests with coverage (if available)
        run: |
          if npm run -s test:coverage >/dev/null 2>&1; then
            npm run test:coverage;
          else
            echo "No test:coverage script defined — skipping";
          fi

      - name: Build (if available)
        run: |
          if npm run -s build >/dev/null 2>&1; then
            npm run build;
          else
            echo "No build script defined — skipping";
          fi

      - name: npm audit (security scan)
        run: |
          echo "Running npm audit (summary only)"
          npm audit --audit-level=moderate || true

      - name: Upload coverage (if coverage produced a file)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage/**
            coverage.*

  python-ci:
    name: Python checks (flake8, pytest)
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: src
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect Python files
        id: detect_py
        run: |
          count=$(git ls-files "**/*.py" | wc -l || true)
          echo "found=$count" >> $GITHUB_OUTPUT

      - name: Skip Python CI if no Python files
        if: steps.detect_py.outputs.found == '0'
        run: echo "No Python files found — skipping Python CI."

      - name: Setup Python
        if: steps.detect_py.outputs.found != '0'
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python test deps
        if: steps.detect_py.outputs.found != '0'
        run: |
          python -m pip install --upgrade pip
          pip install pytest flake8 pytest-cov

          # Install project dependencies
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f setup.py ]; then
            pip install -e .
          fi

      - name: Run flake8
        if: steps.detect_py.outputs.found != '0'
        run: flake8 . || true

      - name: Run pytest (generate JUnit XML and coverage)
        if: steps.detect_py.outputs.found != '0'
        run: pytest --junitxml=reports/junit.xml --cov=src --cov-report=xml:reports/coverage.xml -q

      - name: Upload JUnit report
        if: ${{ always() && (steps.detect_py.outputs.found != '0') }}
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: |
            reports/junit.xml
            reports/**/*.xml

      - name: Upload pytest coverage XML
        if: ${{ always() && (steps.detect_py.outputs.found != '0') }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            reports/coverage.xml
            reports/coverage-*.xml

      - name: Annotate JUnit failures as workflow annotations
        if: ${{ always() && (steps.detect_py.outputs.found != '0') }}
        run: |
          python .github/scripts/annotate_junit.py reports/junit.xml || true

