# ==============================================================================
# PostgreSQL Exporter - Custom Queries
# ==============================================================================

# Database size metrics
pg_database:
  query: |
    SELECT 
      datname as database,
      pg_database_size(datname) as size_bytes,
      numbackends as connections
    FROM pg_database
    WHERE datname NOT IN ('template0', 'template1')
  metrics:
    - database:
        usage: "LABEL"
        description: "Database name"
    - size_bytes:
        usage: "GAUGE"
        description: "Database size in bytes"
    - connections:
        usage: "GAUGE"
        description: "Number of active connections"

# Table size metrics
pg_table_size:
  query: |
    SELECT 
      schemaname,
      tablename,
      pg_total_relation_size(schemaname||'.'||tablename) as total_bytes,
      pg_relation_size(schemaname||'.'||tablename) as table_bytes,
      pg_indexes_size(schemaname||'.'||tablename) as index_bytes
    FROM pg_tables
    WHERE schemaname = 'public'
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - tablename:
        usage: "LABEL"
        description: "Table name"
    - total_bytes:
        usage: "GAUGE"
        description: "Total size including indexes"
    - table_bytes:
        usage: "GAUGE"
        description: "Table size"
    - index_bytes:
        usage: "GAUGE"
        description: "Index size"

# Connection statistics
pg_connections:
  query: |
    SELECT 
      state,
      COUNT(*) as connections
    FROM pg_stat_activity
    WHERE datname = current_database()
    GROUP BY state
  metrics:
    - state:
        usage: "LABEL"
        description: "Connection state"
    - connections:
        usage: "GAUGE"
        description: "Number of connections in state"

# Query performance
pg_slow_queries:
  query: |
    SELECT 
      query,
      calls,
      total_exec_time / 1000 as total_seconds,
      mean_exec_time / 1000 as mean_seconds,
      max_exec_time / 1000 as max_seconds
    FROM pg_stat_statements
    WHERE mean_exec_time > 100
    ORDER BY mean_exec_time DESC
    LIMIT 10
  metrics:
    - query:
        usage: "LABEL"
        description: "SQL query"
    - calls:
        usage: "COUNTER"
        description: "Number of times executed"
    - total_seconds:
        usage: "COUNTER"
        description: "Total execution time in seconds"
    - mean_seconds:
        usage: "GAUGE"
        description: "Mean execution time in seconds"
    - max_seconds:
        usage: "GAUGE"
        description: "Maximum execution time in seconds"

# Replication lag
pg_replication_lag:
  query: |
    SELECT 
      COALESCE(EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())), 0) as lag_seconds
  metrics:
    - lag_seconds:
        usage: "GAUGE"
        description: "Replication lag in seconds"

# Transaction statistics
pg_transactions:
  query: |
    SELECT 
      xact_commit as commits,
      xact_rollback as rollbacks,
      blks_read as blocks_read,
      blks_hit as blocks_hit,
      CASE WHEN (blks_read + blks_hit) > 0 
        THEN blks_hit::float / (blks_read + blks_hit) * 100 
        ELSE 100 
      END as cache_hit_ratio
    FROM pg_stat_database
    WHERE datname = current_database()
  metrics:
    - commits:
        usage: "COUNTER"
        description: "Number of transactions committed"
    - rollbacks:
        usage: "COUNTER"
        description: "Number of transactions rolled back"
    - blocks_read:
        usage: "COUNTER"
        description: "Number of disk blocks read"
    - blocks_hit:
        usage: "COUNTER"
        description: "Number of buffer hits"
    - cache_hit_ratio:
        usage: "GAUGE"
        description: "Cache hit ratio percentage"

# Table statistics
pg_table_stats:
  query: |
    SELECT 
      schemaname,
      tablename,
      seq_scan,
      seq_tup_read,
      idx_scan,
      idx_tup_fetch,
      n_tup_ins,
      n_tup_upd,
      n_tup_del,
      n_live_tup,
      n_dead_tup
    FROM pg_stat_user_tables
  metrics:
    - schemaname:
        usage: "LABEL"
    - tablename:
        usage: "LABEL"
    - seq_scan:
        usage: "COUNTER"
        description: "Number of sequential scans"
    - seq_tup_read:
        usage: "COUNTER"
        description: "Number of tuples read by sequential scans"
    - idx_scan:
        usage: "COUNTER"
        description: "Number of index scans"
    - idx_tup_fetch:
        usage: "COUNTER"
        description: "Number of tuples fetched by index scans"
    - n_tup_ins:
        usage: "COUNTER"
        description: "Number of rows inserted"
    - n_tup_upd:
        usage: "COUNTER"
        description: "Number of rows updated"
    - n_tup_del:
        usage: "COUNTER"
        description: "Number of rows deleted"
    - n_live_tup:
        usage: "GAUGE"
        description: "Estimated number of live rows"
    - n_dead_tup:
        usage: "GAUGE"
        description: "Estimated number of dead rows"

# Locks
pg_locks:
  query: |
    SELECT 
      mode,
      COUNT(*) as count
    FROM pg_locks
    GROUP BY mode
  metrics:
    - mode:
        usage: "LABEL"
        description: "Lock mode"
    - count:
        usage: "GAUGE"
        description: "Number of locks"
